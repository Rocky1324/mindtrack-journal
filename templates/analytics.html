{% extends "layout.html" %}

{% block title %}Analytics & Insights{% endblock %}

{% block content %}
  <h1>📊 Analytics & Insights</h1>

  <div class="chart-grid">
    <div class="chart-card">
      <h4>📈 Mood Trends (Last 30 Days)</h4>
      <div class="chart-wrapper">
        <canvas id="moodChart"></canvas>
        <div id="moodLoading" class="chart-loading">Loading mood data...</div>
        <div id="moodNoData" class="chart-no-data" style="display: none;">
          <div class="icon">😊</div>
          <p>No mood data available</p>
          <p>Start journaling to see your mood trends!</p>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <h4>😰 Stress Levels (Last 30 Days)</h4>
      <div class="chart-wrapper">
        <canvas id="stressChart"></canvas>
        <div id="stressLoading" class="chart-loading">Loading stress data...</div>
        <div id="stressNoData" class="chart-no-data" style="display: none;">
          <div class="icon">😰</div>
          <p>No stress data available</p>
          <p>Complete questionnaires to track stress!</p>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <h4>😴 Sleep Patterns (Last 30 Days)</h4>
      <div class="chart-wrapper">
        <canvas id="sleepChart"></canvas>
        <div id="sleepLoading" class="chart-loading">Loading sleep data...</div>
        <div id="sleepNoData" class="chart-no-data" style="display: none;">
          <div class="icon">😴</div>
          <p>No sleep data available</p>
          <p>Track your sleep in the questionnaire!</p>
        </div>
      </div>
    </div>

    <div class="chart-card">
      <h4>🏃 Exercise Distribution</h4>
      <div class="chart-wrapper">
        <canvas id="exerciseChart"></canvas>
        <div id="exerciseLoading" class="chart-loading">Loading exercise data...</div>
        <div id="exerciseNoData" class="chart-no-data" style="display: none;">
          <div class="icon">🏃</div>
          <p>No exercise data available</p>
          <p>Log your activities to see patterns!</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Chart.js configuration
    Chart.defaults.font.family = 'Inter, sans-serif';
    Chart.defaults.color = '#64748b';
    Chart.defaults.borderColor = '#e2e8f0';
    Chart.defaults.backgroundColor = 'rgba(99, 102, 241, 0.1)';

    // Initialize charts
    let moodChart, stressChart, sleepChart, exerciseChart;

    // Fetch chart data
    fetch('/api/chart-data')
      .then(response => response.json())
      .then(data => {
        createCharts(data);
      })
      .catch(error => {
        console.error('Error fetching chart data:', error);
        showNoDataMessages();
      });

    function createCharts(data) {
      // Hide loading indicators
      document.querySelectorAll('[id$="Loading"]').forEach(el => el.style.display = 'none');

      // Mood Chart
      if (data.mood.data.length > 0) {
        const moodCtx = document.getElementById('moodChart').getContext('2d');
        moodChart = new Chart(moodCtx, {
          type: 'line',
          data: {
            labels: data.mood.labels,
            datasets: [{
              label: 'Mood Rating',
              data: data.mood.data,
              borderColor: '#6366f1',
              backgroundColor: 'rgba(99, 102, 241, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#6366f1',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 10,
                grid: {
                  color: 'rgba(0,0,0,0.05)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } else {
        document.getElementById('moodChart').style.display = 'none';
        document.getElementById('moodNoData').style.display = 'flex';
      }

      // Stress Chart
      if (data.stress.data.length > 0) {
        const stressCtx = document.getElementById('stressChart').getContext('2d');
        stressChart = new Chart(stressCtx, {
          type: 'line',
          data: {
            labels: data.stress.labels,
            datasets: [{
              label: 'Stress Level',
              data: data.stress.data,
              borderColor: '#ef4444',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              borderWidth: 3,
              fill: true,
              tension: 0.4,
              pointBackgroundColor: '#ef4444',
              pointBorderColor: '#ffffff',
              pointBorderWidth: 2,
              pointRadius: 6
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 10,
                grid: {
                  color: 'rgba(0,0,0,0.05)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } else {
        document.getElementById('stressChart').style.display = 'none';
        document.getElementById('stressNoData').style.display = 'flex';
      }

      // Sleep Chart
      if (data.sleep.data.length > 0) {
        const sleepCtx = document.getElementById('sleepChart').getContext('2d');
        sleepChart = new Chart(sleepCtx, {
          type: 'bar',
          data: {
            labels: data.sleep.labels,
            datasets: [{
              label: 'Sleep Hours',
              data: data.sleep.data,
              backgroundColor: '#06b6d4',
              borderColor: '#0891b2',
              borderWidth: 1,
              borderRadius: 6,
              borderSkipped: false
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                display: false
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                max: 12,
                grid: {
                  color: 'rgba(0,0,0,0.05)'
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      } else {
        document.getElementById('sleepChart').style.display = 'none';
        document.getElementById('sleepNoData').style.display = 'flex';
      }

      // Exercise Chart
      if (data.exercise.data.some(val => val > 0)) {
        const exerciseCtx = document.getElementById('exerciseChart').getContext('2d');
        exerciseChart = new Chart(exerciseCtx, {
          type: 'doughnut',
          data: {
            labels: data.exercise.labels,
            datasets: [{
              data: data.exercise.data,
              backgroundColor: [
                '#94a3b8',  // None - gray
                '#10b981',  // Light - green
                '#f59e0b',  // Moderate - yellow
                '#ef4444'   // Intense - red
              ],
              borderWidth: 0,
              cutout: '60%'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 20,
                  usePointStyle: true,
                  pointStyle: 'circle'
                }
              }
            }
          }
        });
      } else {
        document.getElementById('exerciseChart').style.display = 'none';
        document.getElementById('exerciseNoData').style.display = 'flex';
      }
    }

    function showNoDataMessages() {
      document.querySelectorAll('[id$="Loading"]').forEach(el => el.style.display = 'none');
      document.querySelectorAll('[id$="NoData"]').forEach(el => el.style.display = 'flex');
      document.querySelectorAll('canvas').forEach(el => el.style.display = 'none');
    }
  </script>

{% endblock %}
